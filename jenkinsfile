pipeline {
  agent any

  environment {
    DOCKER_IMAGE = "pradeeshan/simple-web-app"
    
  }

  tools {
    nodejs "NodeJS 18" 
  }

  stages {

    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Install Dependencies') {
      steps {
        bat 'npm install'
      }
    }

    stage('Test') {
        failFast true
        parallel {
            stage('Unit Tests') {
                steps {
                    bat 'npm run test:unit'
      }
    }
    stage('Integration Tests') {
      steps {
        bat 'npm run test:integration'
      }
    }
  }
}


    

    stage('Docker Build') {
      steps {
        script {
          dockerImage = docker.build("${DOCKER_IMAGE}:${env.BUILD_NUMBER}")
        }
      }
    }

    stage('Docker Push') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')]) {
          script {
            docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
              dockerImage.push()
              dockerImage.push('latest')
            }
          }
        }
      }
    }

    stage('Deploy (Docker Run)') {
      steps {
        bat """
        docker stop simple-web-app || exit 0
        docker rm simple-web-app || exit 0
        docker run -d -p 3000:3000 --name simple-web-app ${DOCKER_IMAGE}:${env.BUILD_NUMBER}
        """
      }
    }
  }
}
